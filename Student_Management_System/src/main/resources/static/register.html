<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School - Register user</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: #333;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 12px 48px rgba(0,0,0,0.2);
            max-width: 420px;
            width: 100%;
        }
        h1 { color: #1e3a5f; margin-top: 0; font-size: 1.35rem; }
        .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 1.25rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.35rem; font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        input:focus, select:focus {
            outline: none; border-color: #2d5a87; box-shadow: 0 0 0 2px rgba(45, 90, 135, 0.2);
        }
        .btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            background: #2d5a87;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
        }
        .btn:hover { background: #1e3a5f; }
        .btn-outline { background: transparent; color: #666; border: 2px solid #ddd; margin-left: 0.5rem; }
        .btn-outline:hover { background: #f5f5f5; border-color: #999; }
        .error { background: #ffebee; color: #c62828; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 0.6rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; }
        .actions { margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Register user</h1>
        <p class="subtitle">Only teachers can register new users.</p>
        <div id="error" class="error" style="display:none;"></div>
        <div id="success" class="success" style="display:none;"></div>
        <div id="form-wrap">
            <form id="register-form">
                <label for="username">Username</label>
                <input type="text" id="username" required>
                <label for="password">Password</label>
                <input type="password" id="password" required>
                <label for="name">Name</label>
                <input type="text" id="name" required>
                <label for="role">Role</label>
                <select id="role">
                    <option value="STUDENT">Student</option>
                    <option value="TEACHER">Teacher</option>
                </select>
                <label for="email">Email</label>
                <input type="email" id="email">
                <label for="grade">Grade</label>
                <input type="text" id="grade" placeholder="For students">
                <div class="actions">
                    <button type="submit" class="btn">Register</button>
                    <a href="/welcome.html" class="btn btn-outline">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    <script>
        (function () {
            var errorDiv = document.getElementById('error');
            var successDiv = document.getElementById('success');
            var formWrap = document.getElementById('form-wrap');

            function showError(msg) {
                errorDiv.textContent = msg;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
            function showSuccess(msg) {
                successDiv.textContent = msg;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }

            fetch('/api/auth/me', { credentials: 'same-origin' })
                .then(function (r) {
                    if (!r.ok) throw new Error('Not logged in');
                    return r.json();
                })
                .then(function (me) {
                    if (me.role !== 'TEACHER') {
                        window.location.href = '/welcome.html';
                        return;
                    }
                })
                .catch(function () {
                    window.location.href = '/login.html';
                });

            document.getElementById('register-form').addEventListener('submit', function (e) {
                e.preventDefault();
                var payload = {
                    username: document.getElementById('username').value.trim(),
                    password: document.getElementById('password').value,
                    name: document.getElementById('name').value.trim(),
                    role: document.getElementById('role').value,
                    email: document.getElementById('email').value.trim() || null,
                    grade: document.getElementById('grade').value.trim() || null
                };
                if (!payload.username || !payload.password || !payload.name) {
                    showError('Username, password and name are required.');
                    return;
                }
                fetch('/api/auth/register', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                    .then(function (r) {
                        return r.json().then(function (data) {
                            if (!r.ok) throw new Error(data.error || 'Registration failed');
                            showSuccess('User "' + data.username + '" registered.');
                            document.getElementById('register-form').reset();
                        });
                    })
                    .catch(function (err) {
                        showError(err.message || 'Registration failed.');
                    });
            });
        })();
    </script>
</body>
</html>
